## 🧩 一般公司性能测试需求说明书（模板）

### 📘 项目名称：

商城系统性能测试

------

### 🧭 一、测试背景与目的

当前商城系统即将上线，涉及多个核心接口（用户登录、商品查询、下单、支付），为了保障系统在上线初期及促销高峰期的稳定性，需进行系统级性能测试，识别潜在瓶颈，确保系统在并发高压下的可用性。

------

### 📦 二、测试对象

#### 1. 系统范围：

- 用户系统（登录、注册）
- 商品系统（商品列表、详情）
- 订单系统（提交订单、查询订单）
- 支付系统（模拟支付请求）

#### 2. 目标接口列表：



| 接口模块 | 接口路径            | 请求方法 | 是否重点接口 |
| -------- | ------------------- | -------- | ------------ |
| 登录     | `/api/login`        | POST     | ✅ 是         |
| 商品查询 | `/api/products`     | GET      | ✅ 是         |
| 下单     | `/api/order/create` | POST     | ✅ 是         |
| 支付     | `/api/payment/pay`  | POST     | ✅ 是         |

------

### 🧪 三、测试目标（量化指标）



| 指标项           | 目标值                 |
| ---------------- | ---------------------- |
| 平均响应时间     | ≤ 800ms                |
| 最大响应时间     | ≤ 3000ms               |
| 吞吐量 TPS       | ≥ 200                  |
| 成功率（2xx）    | ≥ 99%                  |
| CPU 使用率       | ≤ 80%                  |
| 内存使用率       | ≤ 75%                  |
| 磁盘 IO 等待     | ≤ 10ms                 |
| 系统稳定运行时间 | ≥ 60分钟持续压测无异常 |

------

### 🧰 四、测试环境



| 环境类型 | 说明                         |
| -------- | ---------------------------- |
| 测试系统 | CentOS 7.9，2核4G，50GB 磁盘 |
| 中间件   | Nginx + MySQL + Redis        |
| 数据量   | 用户 10w，商品 1w，订单 5w   |

------

### 🔧 五、测试工具



| 工具            | 作用                   |
| --------------- | ---------------------- |
| JMeter          | 模拟接口压测请求       |
| Prometheus      | 监控系统资源指标       |
| Grafana         | 实时可视化展示指标图表 |
| Allure          | 测试报告生成           |
| Jenkins（可选） | 自动化触发测试         |

------



### 🧩 六、测试场景设计

#### 典型场景示例：



| 场景编号 | 场景描述         | 并发用户数 | 持续时间 | 操作内容               |
| -------- | ---------------- | ---------- | -------- | ---------------------- |
| SC001    | 登录并发测试     | 500        | 10 分钟  | 模拟多用户登录         |
| SC002    | 查询商品接口性能 | 300        | 10 分钟  | 查询商品列表+详情      |
| SC003    | 下单流程完整压测 | 200        | 15 分钟  | 创建订单 -> 模拟支付   |
| SC004    | 高并发混合场景   | 1000       | 30 分钟  | 登录 + 下单 + 查询组合 |

------

🔹 **SC001 登录并发测试**

> 并发用户数：**500**
>  持续时间：**10 分钟**
>  操作内容：**模拟多用户登录**

## ✅ Stepping Thread Group 配置填写如下：



| 配置项（JMeter 界面字段） | 说明                                       | 你的填写值 | 单位（备注）               |
| ------------------------- | ------------------------------------------ | ---------- | -------------------------- |
| **This group will start** | 总线程数（用户数）                         | `500`      | 数量（最大并发用户）       |
| **First, wait for**       | 脚本执行前延迟（预热期，可填 0）           | `0`        | 秒                         |
| **Then start**            | 初始启动线程数                             | `50`       | 数量                       |
| **Next, add**             | 每轮增加的线程数                           | `50`       | 数量                       |
| **threads every**         | 每轮间隔时间25                             | 15         | 秒                         |
| **using ramp-up**         | 每批线程的“启动耗时”（线程分布的持续时间） | `10`       | 秒，表示这一批线程均匀启动 |
| **Then hold load for**    | 达到总线程数后的持续时间                   | `300`      | 秒（5 分钟）               |
| **Finally, stop**         | 每次停止线程数（可填 0 表示立即全部停止）  | `0`        | 数量                       |
| **threads every**         | 每批停止线程的间隔时间（配合上面使用）     | `1`        | 秒（此项无效，因 stop=0）  |

------

### 📌 简要执行流程说明：

```
python-repl复制编辑0s：启动 50 个线程
10s：增加 50（到 100）
20s：增加 50（到 150）
...
90s：增加到 500
100s ~ 400s（第2~7分钟）：保持 500 并发稳定执行
400s 后：立即全部停止
```

### 📌 准备数据

### 📌 执行脚本

### 📌 测试结果

### 🧪 登录接口性能测试总结报告（SC001）

------

#### 📌 场景信息

| 场景编号 | 场景描述     | 并发用户数 | 持续时间 | 操作内容       | 场景合理性说明                                               |
| -------- | ------------ | ---------- | -------- | -------------- | ------------------------------------------------------------ |
| SC001    | 登录并发测试 | 500        | 10 分钟  | 模拟多用户登录 | 已符合一般公司业务要求场景设计。多数企业后台系统登录并发在几十至几百，电商/政务/大型 SaaS 平台可能超过 1000。本次设置 500 用户、10 分钟持续压测，具备一定代表性和压力，属于中高强度验证，适合系统上线前稳定性评估。 |

------

#### 🧾 测试指标概览

| 指标项               | 数据                     | 结论说明             |
| -------------------- | ------------------------ | -------------------- |
| ✅ 请求总数           | 11,335 次                | 正常                 |
| ✅ 并发线程数         | 峰值 500，分阶段稳步升压 | 达到测试目标         |
| ✅ 错误率             | 0.00%                    | 稳定无错误           |
| ⏱️ 平均响应时间（RT） | 18,952 ms                | 偏高                 |
| ⏱️ P90 响应时间       | 25,596 ms                | 存在请求积压         |
| ⏱️ 最大响应时间       | 27,688 ms                | 极端慢请求存在       |
| ⚡ 吞吐量（TPS）      | 平均 20.4 次/秒          | 波动大，处理能力受限 |
| 🧠 CPU 使用率         | 峰值 100%                | 达瓶颈，需优化       |
| 🧠 内存使用率         | 峰值约 34%               | 尚可                 |
| 🧠 系统 1m Load       | 峰值高达 200+            | 严重拥堵             |

------

#### 🧮 数据库支撑量级

| 指标项     | mall_tiny 数据库 |
| ---------- | ---------------- |
| 表数量     | 61 张            |
| 总行数     | 155,954 行       |
| 数据大小   | 12.84 MB         |
| 索引大小   | 0.03 MB          |
| 总占用体积 | 12.88 MB         |

该数据量对登录场景属于较小量级，理论上可承载更高 TPS，因此响应慢问题更可能是应用处理/资源瓶颈而非数据支撑问题。

------

#### 🔍 初步分析结论

1. **响应时间偏高**，尤其 P90 >25s，影响用户体验。
2. **TPS 波动明显**，并未充分稳定维持在高吞吐水平。
3. **服务器 CPU 资源紧张**，达到 100%，成为性能瓶颈。
4. **接口逻辑稳定**，错误率为 0，功能执行可靠。

------

#### ✅ 优化建议

| 方向       | 建议措施                                                |
| ---------- | ------------------------------------------------------- |
| 🧱 系统资源 | 升级 CPU 至 4 核及以上，或使用多实例部署                |
| 🧰 登录逻辑 | 检查是否有 Redis 缓存优化空间（验证码、Token 频繁查询） |
| 🧵 接口结构 | 避免过多同步 I/O，必要时使用异步处理或连接池优化        |
| ⚙️ 网关层面 | 检查是否存在 Nginx、LB 层限流或均衡问题                 |

------

若需生成 Word 或 PDF 格式，请告知导出格式。





### 📊 七、测试结果输出（目标）

- Allure 测试报告 + TPS/RT 图表
- Grafana 资源曲线截图（CPU、Memory、带宽、IO）
- 压测结论（是否达标 + 问题点 + 优化建议）

------

### 💡 八、风险与优化建议（可选）

- 瓶颈模块：数据库写入延迟、缓存未命中、接口无限重试逻辑
- 建议：添加限流、使用缓存优化、接口分页、防重复提交等

=======================















## 🎯 场景目标（你现在的目的）

> 🔧 自建环境，模拟并发登录请求，对登录接口进行完整性能测试，包括并发响应、错误率、TPS、服务器资源使用等。



telnet 不通解决方案：

```
iptables -I INPUT -p tcp --dport 4444 -j ACCEPT
iptables -I OUTPUT -p tcp --sport 4444 -j ACCEPT

```

http://129.28.122.208:9090服务器1Grey** VM-0-14：Jenkins、JDK、Maven、Git、Redis、Prometheus、Allure、Redis

http://1.12.52.242:9100服务器2Athena** VM-0-13：Java服务、JDK、Node Exporter、JMX Exporter、

http://114.132.198.29/**服务器3 MM** VM-0-5：JMeter、Grafana、ServerAgent

## 

## 可运行的Jenkinsfile脚本（跑性能测试脚本.jmx）

```
pipeline {
    agent any

    environment {
        REMOTE_HOST    = 'root@114.132.198.29'
        JMETER_HOME    = '/athena/Jmeter/apache-jmeter-5.5'
        JMETER_BASEDIR = '/athena/Jmeter'

        JMETER_SCRIPT  = "${JMETER_BASEDIR}/ProductionPerfMall.jmx"
        JMETER_OUTPUT  = "${JMETER_BASEDIR}/result.jtl"
        JMETER_REPORT  = "${JMETER_BASEDIR}/ResultHtml"
        JMETER_PLUGIN  = "${JMETER_HOME}/lib/ext/jmeter-plugins-casutg-2.9.jar"
    }

    triggers {
        githubPush()
    }

    stages {
        stage('拉取代码') {
            steps {
                echo '✅ 代码已拉取成功！'
            }
        }

        stage('上传 JMeter 脚本') {
            steps {
                echo '📤 上传 JMeter 脚本到远程服务器...'
                sh '''
                    scp -o StrictHostKeyChecking=no ProductionPerfMall.jmx ${REMOTE_HOST}:${JMETER_SCRIPT}
                '''
            }
        }

        stage('检查并安装 JMeter 插件') {
            steps {
                echo '🔍 检查 Stepping Thread Group 插件...'
                sh """
                    ssh -o StrictHostKeyChecking=no ${REMOTE_HOST} '
                        if [ ! -f "${JMETER_PLUGIN}" ]; then
                            echo "📦 插件不存在，正在下载..."
                            wget -O "${JMETER_PLUGIN}" https://repo1.maven.org/maven2/kg/apc/jmeter-plugins-casutg/2.9/jmeter-plugins-casutg-2.9.jar
                            chmod 644 "${JMETER_PLUGIN}"
                        else
                            echo "✅ 插件已存在，跳过下载。"
                        fi
                    '
                """
            }
        }

        stage('执行 JMeter 压测') {
            steps {
                echo '🚀 开始执行远程 JMeter 测试脚本...'
                sh """
                    ssh -o StrictHostKeyChecking=no ${REMOTE_HOST} '
                        export JAVA_HOME=/athena/jdk/jdk1.8.0_371
                        export PATH=$JAVA_HOME/bin:$PATH

                        echo "🧹 清理旧报告..."
                        rm -rf ${JMETER_REPORT}
                        rm -f ${JMETER_OUTPUT}

                        echo "📊 执行 JMeter 压测..."
                        ${JMETER_HOME}/bin/jmeter \\
                            -n -t ${JMETER_SCRIPT} \\
                            -l ${JMETER_OUTPUT} \\
                            -e -o ${JMETER_REPORT}
                    '
                """
            }
        }

        stage('拉取 HTML 报告') {
            steps {
                echo '📥 拉取 HTML 报告到 Jenkins 本地...'
                sh '''
                    rm -rf ResultHtml
                    scp -r -o StrictHostKeyChecking=no ${REMOTE_HOST}:${JMETER_REPORT} ./ResultHtml
                '''
            }
        }

        stage('展示 HTML 报告') {
            steps {
                script {
                    def reportName = '📊 JMeter HTML 性能报告'
                    def reportDir = 'ResultHtml'
                    def reportFile = 'index.html'

                    publishHTML(target: [
                        reportDir: reportDir,
                        reportFiles: reportFile,
                        reportName: reportName,
                        reportTitles: 'JMeter 执行详情报告',
                        allowMissing: false,
                        alwaysLinkToLastBuild: true,
                        keepAll: true,
                        includes: '**/*.html, **/*.js, **/*.css, **/*.png, **/*.jpg'
                    ])

                    echo "🔗 HTML 报告链接：${env.BUILD_URL}HTML_20Report"
                }
            }
        }

        stage('完成') {
            steps {
                echo "🎉 JMeter 性能测试完成，HTML 报告已集成 Jenkins 页面。"
            }
        }
    }
}

```



# 📘 性能测试全链路实施方案（含监控与告警）

## ✅ 一、方案目标

构建一套**稳定、可扩展、可监控**的性能测试体系，实现以下目标：

- 覆盖接口级、系统级、业务级性能测试
- 支持压测、瓶颈定位、调优建议、容量评估
- 提供实时资源监控与告警，形成**完整闭环**

------

## ⚙️ 二、技术选型与工具链

| 模块     | 工具 / 技术                 | 说明                                  |                                                              |
| -------- | --------------------------- | ------------------------------------- | ------------------------------------------------------------ |
| 性能压测 | JMeter / Gatling            | 支持 HTTP/S、WebSocket、MQ 等协议压测 |                                                              |
| 服务部署 | 手动部署 / Shell            | 脚本                                  | 考虑服务器资源限制（内存小、磁盘小），不建议使用 Docker，推荐轻量化部署方式 |
| JVM 监控 | JMX Exporter + Prometheus   | 实时采集 GC、线程、内存、类加载等数据 |                                                              |
| 系统监控 | Node Exporter               | CPU、内存、磁盘、网络等系统指标       |                                                              |
| 资源采集 | Server Agent（JMeter 插件） | 收集服务器资源（多台服务器）          |                                                              |
| 数据聚合 | Prometheus                  | 时间序列数据库，负责指标采集与聚合    |                                                              |
| 可视化   | Grafana                     | 实时仪表盘，支持自定义报警阈值        |                                                              |
| 报告输出 | Allure / JMeter Dashboard   | 可视化测试报告，支持趋势分析          |                                                              |
| 告警通知 | Alertmanager / 企业微信等   | 实时推送异常指标                      |                                                              |

------

## 🧪 三、实施步骤全流程

1. **场景设计**
   - 识别核心业务路径、接口优先级
   - 设定 QPS、并发用户数、压测时长等参数
   - 设计数据准备方案（动态参数化、账号池）
2. **脚本开发**
   - 使用 JMeter 编写请求逻辑、断言、关联处理
   - 支持 CSV 参数、BeanShell、Groovy 脚本增强逻辑
   - 接入数据库校验或 Redis 校验作为后置断言
3. **脚本验证**
   - 本地单用户测试验证接口稳定性和数据正确性
   - 配置 Debug Sampler 输出请求详情
4. **执行压测**
   - 使用 CLI 模式运行 JMeter 测试计划
   - 配置聚合报告、保存日志、启用远程压测节点
   - 压测过程中实时观察资源变化趋势图
5. **性能监控**
   - 启动 Node Exporter / JMX Exporter 采集指标
   - Prometheus 拉取指标数据
   - Grafana 实时展示 CPU、内存、GC、线程池使用率等
6. **告警配置**
   - 配置 Alertmanager，设置告警规则（如 CPU > 80% 持续 1 分钟）
   - 告警通知方式：邮件 / 企业微信 / 钉钉 / Slack
   - 告警内容包含：指标名称、影响服务、主机、时间、建议处理方式
7. **压测报告**
   - 聚合 TPS、响应时间、错误率、断言失败等核心数据
   - 使用 Allure 展示测试详情，结合 Prometheus 数据形成性能趋势报告
   - 输出瓶颈分析与调优建议（如 DB 慢查询、线程池不足、GC 频繁等）

------

## 📊 四、Grafana 监控面板推荐指标

| 指标分类 | 监控项                         | 说明               |
| -------- | ------------------------------ | ------------------ |
| CPU      | CPU 使用率、负载、上下文切换   | 判断是否 CPU 饱和  |
| 内存     | Used / Free / Cache / Swap     | 是否出现内存泄露   |
| JVM      | GC 次数、GC 时间、堆内存使用率 | 判断垃圾回收压力   |
| 线程     | 活跃线程数、死锁线程           | 判断线程池是否拥堵 |
| 磁盘     | I/O 吞吐、I/O 等待、空间占用   | 磁盘瓶颈或空间不足 |
| 网络     | 吞吐量、连接数、丢包率         | 网络是否成为瓶颈   |
| 应用     | QPS、响应时间、95分位、错误率  | 直接反映业务健康度 |

------

## 🚨 五、告警策略建议

| 告警等级 | 示例指标                       | 动作                        |
| -------- | ------------------------------ | --------------------------- |
| 严重     | CPU > 95%，持续 2 分钟         | 立即告警 + Jenkins 停止构建 |
| 一般     | 内存使用率 > 85%               | 告警通知 + 建议关注         |
| 预警     | QPS 突增 50%，响应时间上升 20% | 标记趋势 + 更新性能记录     |
| 恢复     | 指标恢复至正常阈值以下         | 发送恢复通知                |

------

## 🧩 六、最佳实践

- 所有压测用例应版本化管理（如 Git 仓库）
- 对每次压测结果与指标进行归档与对比
- 压测结果需配合日志、慢 SQL、线程 dump 等进行综合分析
- 与研发、运维联动，进行优化闭环跟进

------

## 📂 七、目录结构推荐（压测项目）

```
performance/
├── testcases/             # JMeter 脚本与数据
├── reports/               # 测试报告输出目录
├── monitor/               # Prometheus 与 Grafana 配置
├── docker-compose.yml     # 一键启动监控与压测环境
└── README.md              # 使用说明与脚本执行方式
```

------

## 🔚 八、总结

通过该全链路性能测试方案，可以实现：

- 一致性测试环境部署
- 实时资源指标监控 + 自定义告警
- 全流程脚本开发、执行、回溯
- 针对瓶颈精准定位与优化建议

> ✅ 适用于日常回归压测 / 大促保驾压测 / 服务容量评估等多种场景

------

## 🖥️ 九、服务器配置与部署建议

### 🚀 当前测试环境服务器配置对比表：

| 项目     | 服务器1（VM-0-14）       | 服务器2（VM-0-13）        | 服务器3（VM-0-5）         |
| -------- | ------------------------ | ------------------------- | ------------------------- |
| CPU      | 2 核（Intel Xeon 8255C） | 2 核（AMD）               | 2 核（AMD）               |
| 超线程   | 无（1线程/核）           | 有（2线程/核）            | 有（2线程/核）            |
| 内存     | 1.7G（可用约 313Mi）     | 3.6G（可用约 3.1Gi）      | 3.6G（可用约 3.1Gi）      |
| 磁盘大小 | 50G                      | 296G                      | 20G                       |
| 系统版本 | CentOS Stream 8          | CentOS Stream 9           | CentOS Stream 9           |
| CPU 类型 | Intel Xeon @2.50GHz      | General Processors（AMD） | General Processors（AMD） |
| 当前负载 | 0.01（空闲）             | 0.02（非常轻）            | 0.00（空闲）              |

### ✅ 部署建议：

- **压测执行节点建议部署在资源更充足的服务器2**（内存、磁盘富余，支持超线程）
- **监控系统建议部署在服务器1**（尽管内存少但负载低，适合轻量任务如 Prometheus、Grafana）
- **服务端待压测目标建议分布在服务器3**，根据业务隔离实际评估资源是否足够

> ℹ️ 如果涉及多用户并发或长时间稳定压测，建议至少 4核+8G 以上资源进行模拟与采集，避免压测节点自身成为瓶颈

------

